name: iOS Production Build (Local - No EAS Credits)

on:
  workflow_dispatch: {}  # Manual trigger only

env:
  NODE_VERSION: '20'

jobs:
  build-ios-local:
    name: Build iOS IPA Locally (No EAS Credits)
    runs-on: macos-latest
    timeout-minutes: 90
    
    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch full history

      - name: ðŸ” Verify project structure
        run: |
          echo "Verifying project structure..."
          ls -la | head -20
          if [ -f "package-lock.json" ]; then
            echo "âœ… package-lock.json found"
          else
            echo "âŒ package-lock.json not found"
            exit 1
          fi

      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: ${{ env.NODE_VERSION }}
          # Using v3 to avoid auto-caching issues in v4

      - name: ðŸ”§ Install dependencies
        run: npm ci

      - name: ðŸš€ Setup Expo CLI
        uses: expo/expo-github-action@v8
        with:
          expo-version: latest
          token: ${{ secrets.EXPO_TOKEN }}

      - name: ðŸ“± Prebuild iOS project
        run: |
          echo "Generating native iOS project..."
          npx expo prebuild --platform ios --clean
        env:
          EXPO_PUBLIC_SUPABASE_URL: ${{ secrets.EXPO_PUBLIC_SUPABASE_URL }}
          EXPO_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.EXPO_PUBLIC_SUPABASE_ANON_KEY }}

      - name: ðŸ” Setup Code Signing
        run: |
          echo "Setting up code signing..."
          echo "Note: Code signing will use automatic signing with your Apple Team ID"
          echo "Make sure you've configured iOS credentials with: eas credentials --platform ios"
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}

      - name: ðŸ“ Create Export Options
        run: |
          echo "Creating exportOptions.plist..."
          cat > ios/exportOptions.plist << EOF
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
              <key>method</key>
              <string>app-store</string>
              <key>teamID</key>
              <string>${{ secrets.APPLE_TEAM_ID }}</string>
              <key>uploadBitcode</key>
              <false/>
              <key>uploadSymbols</key>
              <true/>
              <key>compileBitcode</key>
              <false/>
              <key>signingStyle</key>
              <string>automatic</string>
              <key>signingCertificate</key>
              <string>Apple Distribution</string>
              <key>provisioningProfiles</key>
              <dict>
                  <key>com.applotictech.flexaura</key>
                  <string></string>
              </dict>
          </dict>
          </plist>
          EOF
          echo "Export options created"

      - name: ðŸ”§ Fix Podfile Code Signing
        working-directory: ./ios
        run: |
          echo "Fixing Podfile to disable code signing for Pods..."
          
          if [ ! -f "Podfile" ]; then
            echo "Error: Podfile not found"
            exit 1
          fi
          
          # Backup Podfile
          cp Podfile Podfile.backup
          
          # Check if code signing settings already exist
          if grep -q "CODE_SIGN_IDENTITY" Podfile && grep -q "CODE_SIGNING_REQUIRED" Podfile; then
            echo "Code signing settings already present, skipping..."
            exit 0
          fi
          
          # Write Python script to a file to avoid YAML parsing issues
          cat > fix_podfile.py << 'PYEOF'
import re
import sys

with open('Podfile', 'r') as f:
    lines = f.readlines()

# Find post_install block
post_install_start = -1
post_install_end = -1
indent_level = 0
in_post_install = False

for i, line in enumerate(lines):
    if re.match(r'^\s*post_install do', line):
        post_install_start = i
        in_post_install = True
        indent_level = len(line) - len(line.lstrip())
    elif in_post_install:
        current_indent = len(line) - len(line.lstrip())
        if line.strip() == 'end' and current_indent <= indent_level:
            post_install_end = i
            break

if post_install_start >= 0 and post_install_end >= 0:
    print(f"Found existing post_install hook (lines {post_install_start+1}-{post_install_end+1})")
    code_signing = ' ' * (indent_level + 2) + "# Disable code signing for Pods\n"
    code_signing += ' ' * (indent_level + 2) + "installer.pods_project.targets.each do |target|\n"
    code_signing += ' ' * (indent_level + 4) + "target.build_configurations.each do |config|\n"
    code_signing += ' ' * (indent_level + 6) + "config.build_settings['CODE_SIGN_IDENTITY'] = ''\n"
    code_signing += ' ' * (indent_level + 6) + "config.build_settings['CODE_SIGNING_REQUIRED'] = 'NO'\n"
    code_signing += ' ' * (indent_level + 6) + "config.build_settings['CODE_SIGNING_ALLOWED'] = 'NO'\n"
    code_signing += ' ' * (indent_level + 6) + "config.build_settings['CODE_SIGN_STYLE'] = 'Manual'\n"
    code_signing += ' ' * (indent_level + 4) + "end\n"
    code_signing += ' ' * (indent_level + 2) + "end\n"
    lines.insert(post_install_end, code_signing)
else:
    print("No existing post_install hook found, adding new one at the end...")
    while lines and lines[-1].strip() == '':
        lines.pop()
    lines.append('\n')
    lines.append('post_install do |installer|\n')
    lines.append('  installer.pods_project.targets.each do |target|\n')
    lines.append('    target.build_configurations.each do |config|\n')
    lines.append("      config.build_settings['CODE_SIGN_IDENTITY'] = ''\n")
    lines.append("      config.build_settings['CODE_SIGNING_REQUIRED'] = 'NO'\n")
    lines.append("      config.build_settings['CODE_SIGNING_ALLOWED'] = 'NO'\n")
    lines.append("      config.build_settings['CODE_SIGN_STYLE'] = 'Manual'\n")
    lines.append('    end\n')
    lines.append('  end\n')
    lines.append('end\n')

with open('Podfile', 'w') as f:
    f.writelines(lines)

print("âœ… Podfile updated successfully")
PYEOF
          
          # Execute the Python script
          python3 fix_podfile.py
          rm -f fix_podfile.py
          
          echo ""
          echo "Verifying Podfile structure:"
          echo "Number of 'post_install do' declarations:"
          grep -c "^post_install do\|^  post_install do" Podfile || echo "0"
          echo ""
          echo "Last 25 lines of Podfile:"
          tail -25 Podfile

      - name: ðŸ“¦ Install CocoaPods dependencies
        working-directory: ./ios
        run: |
          echo "Installing CocoaPods dependencies..."
          echo "Verifying Podfile has post_install hook:"
          grep -A 10 "post_install" Podfile || echo "WARNING: post_install not found!"
          sudo gem install cocoapods
          pod install --repo-update

      - name: ðŸ” Find Xcode Scheme
        working-directory: ./ios
        run: |
          echo "Finding Xcode scheme..."
          WORKSPACE=$(find . -name "*.xcworkspace" | head -1)
          if [ -z "$WORKSPACE" ]; then
            echo "Error: No .xcworkspace found"
            exit 1
          fi
          
          echo "Workspace: $WORKSPACE"
          
          # Get the actual app project name (not Pods)
          APP_PROJECT=$(find . -name "*.xcodeproj" -not -path "*/Pods/*" | head -1)
          if [ -z "$APP_PROJECT" ]; then
            echo "Error: No app project found"
            exit 1
          fi
          
          echo "App project: $APP_PROJECT"
          
          # List schemes from the app project (not workspace, to avoid Pods schemes)
          ALL_SCHEMES=$(xcodebuild -list -project "$APP_PROJECT" 2>/dev/null | grep -A 20 "Schemes:" | grep -v "Schemes:" | grep -v "^--" | grep -v "^$" | xargs)
          echo "App schemes: $ALL_SCHEMES"
          
          # Try to find scheme matching app name
          SCHEME=$(echo "$ALL_SCHEMES" | tr ' ' '\n' | grep -i "flex\|aura" | head -1 | xargs || echo "")
          
          # If not found, use first scheme from app project
          if [ -z "$SCHEME" ] || [ "$SCHEME" = "" ]; then
            SCHEME=$(echo "$ALL_SCHEMES" | tr ' ' '\n' | head -1 | xargs || echo "")
          fi
          
          # Final fallback
          if [ -z "$SCHEME" ] || [ "$SCHEME" = "" ]; then
            SCHEME="FlexAura"
            echo "Using default scheme: $SCHEME"
          fi
          
          echo "âœ… Selected scheme: $SCHEME"
          echo "SCHEME_NAME=$SCHEME" >> $GITHUB_ENV

      - name: ðŸ—ï¸ Build Archive with Xcode
        working-directory: ./ios
        run: |
          echo "Building iOS archive..."
          
          # Find workspace
          WORKSPACE=$(find . -name "*.xcworkspace" | head -1)
          echo "Using workspace: $WORKSPACE"
          
          # Create build directory
          mkdir -p ./build
          
          # Build archive with absolute path
          ARCHIVE_PATH="$(pwd)/build/flex-aura.xcarchive"
          echo "Archive will be created at: $ARCHIVE_PATH"
          
          # Build for iOS device (not simulator)
          # Remove xcpretty to see actual errors
          set -o pipefail
          xcodebuild clean archive \
            -workspace "$WORKSPACE" \
            -scheme "${{ env.SCHEME_NAME }}" \
            -configuration Release \
            -destination "generic/platform=iOS" \
            -archivePath "$ARCHIVE_PATH" \
            -allowProvisioningUpdates \
            DEVELOPMENT_TEAM="${{ secrets.APPLE_TEAM_ID }}" \
            CODE_SIGN_IDENTITY="Apple Distribution" \
            CODE_SIGN_STYLE="Automatic" \
            CODE_SIGNING_REQUIRED=YES \
            CODE_SIGNING_ALLOWED=YES \
            2>&1 | tee /tmp/xcodebuild.log
          
          BUILD_EXIT_CODE=${PIPESTATUS[0]}
          if [ $BUILD_EXIT_CODE -ne 0 ]; then
            echo "âŒ Archive build failed with exit code: $BUILD_EXIT_CODE"
            echo "=== Searching for actual errors (not warnings) ==="
            grep -i "error\|failed\|fatal" /tmp/xcodebuild.log | head -20 || echo "No clear errors found, showing last 30 lines:"
            tail -30 /tmp/xcodebuild.log
            exit $BUILD_EXIT_CODE
          fi
          
          # Verify archive exists
          if [ -d "$ARCHIVE_PATH" ]; then
            echo "âœ… Archive created successfully at: $ARCHIVE_PATH"
            echo "ARCHIVE_PATH=$ARCHIVE_PATH" >> $GITHUB_ENV
          else
            echo "âŒ Archive not found at: $ARCHIVE_PATH"
            echo "Listing build directory:"
            ls -la ./build/ || echo "Build directory doesn't exist"
            exit 1
          fi

      - name: ðŸ“¦ Export IPA
        working-directory: ./ios
        run: |
          echo "Exporting IPA from archive..."
          
          # Use the archive path from previous step
          ARCHIVE_PATH="${{ env.ARCHIVE_PATH }}"
          if [ -z "$ARCHIVE_PATH" ]; then
            ARCHIVE_PATH="$(pwd)/build/flex-aura.xcarchive"
          fi
          
          echo "Looking for archive at: $ARCHIVE_PATH"
          
          # Verify archive exists
          if [ ! -d "$ARCHIVE_PATH" ]; then
            echo "âŒ Archive not found at: $ARCHIVE_PATH"
            echo "Current directory: $(pwd)"
            echo "Listing ios directory:"
            ls -la
            echo "Listing build directory (if exists):"
            ls -la ./build/ 2>/dev/null || echo "Build directory doesn't exist"
            exit 1
          fi
          
          echo "âœ… Archive found, proceeding with export..."
          
          EXPORT_PATH="$(pwd)/build"
          xcodebuild -exportArchive \
            -archivePath "$ARCHIVE_PATH" \
            -exportPath "$EXPORT_PATH" \
            -exportOptionsPlist ./exportOptions.plist \
            -allowProvisioningUpdates
          
          echo "IPA exported successfully"
          
          # Find the IPA file
          IPA_FILE=$(find "$EXPORT_PATH" -name "*.ipa" | head -1)
          if [ -z "$IPA_FILE" ]; then
            echo "âŒ IPA file not found in $EXPORT_PATH"
            echo "Listing export directory:"
            ls -la "$EXPORT_PATH"
            exit 1
          fi
          
          echo "âœ… IPA file found: $IPA_FILE"
          echo "IPA_PATH=$IPA_FILE" >> $GITHUB_ENV

      - name: ðŸ“¤ Upload IPA artifact
        uses: actions/upload-artifact@v4
        with:
          name: ios-production-ipa
          path: ios/build/*.ipa
          retention-days: 30
          if-no-files-found: error

      - name: ðŸ“‹ Build Summary
        run: |
          echo "## âœ… iOS Build Complete (Local Build)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Your IPA has been built locally on GitHub Actions Mac runner." >> $GITHUB_STEP_SUMMARY
          echo "**âœ… No EAS Build credits were used!**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Next Steps:**" >> $GITHUB_STEP_SUMMARY
          echo "1. Download the IPA from workflow artifacts (above)" >> $GITHUB_STEP_SUMMARY
          echo "2. Submit to App Store Connect:" >> $GITHUB_STEP_SUMMARY
          echo "   - Go to [App Store Connect](https://appstoreconnect.apple.com)" >> $GITHUB_STEP_SUMMARY
          echo "   - Upload the IPA manually, or" >> $GITHUB_STEP_SUMMARY
          echo "   - Use: \`eas submit --platform ios --path <ipa-file>\`" >> $GITHUB_STEP_SUMMARY
