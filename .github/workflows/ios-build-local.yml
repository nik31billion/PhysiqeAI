name: iOS Production Build (Local - No EAS Credits)

on:
  workflow_dispatch:  # Manual trigger only

env:
  NODE_VERSION: '20'

jobs:
  build-ios-local:
    name: Build iOS IPA Locally (No EAS Credits)
    runs-on: macos-latest
    timeout-minutes: 90
    
    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch full history

      - name: ðŸ” Verify project structure
        run: |
          echo "Verifying project structure..."
          ls -la | head -20
          if [ -f "package-lock.json" ]; then
            echo "âœ… package-lock.json found"
          else
            echo "âŒ package-lock.json not found"
            exit 1
          fi

      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: ${{ env.NODE_VERSION }}
          # Using v3 to avoid auto-caching issues in v4

      - name: ðŸ”§ Install dependencies
        run: npm ci

      - name: ðŸš€ Setup Expo CLI
        uses: expo/expo-github-action@v8
        with:
          expo-version: latest
          token: ${{ secrets.EXPO_TOKEN }}

      - name: ðŸ“± Prebuild iOS project
        run: |
          echo "Generating native iOS project..."
          npx expo prebuild --platform ios --clean
        env:
          EXPO_PUBLIC_SUPABASE_URL: ${{ secrets.EXPO_PUBLIC_SUPABASE_URL }}
          EXPO_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.EXPO_PUBLIC_SUPABASE_ANON_KEY }}

      - name: ðŸ” Setup Code Signing
        run: |
          echo "Setting up code signing..."
          echo "Note: Code signing will use automatic signing with your Apple Team ID"
          echo "Make sure you've configured iOS credentials with: eas credentials --platform ios"
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}

      - name: ðŸ“ Create Export Options
        run: |
          echo "Creating exportOptions.plist..."
          cat > ios/exportOptions.plist << EOF
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
              <key>method</key>
              <string>app-store</string>
              <key>teamID</key>
              <string>${{ secrets.APPLE_TEAM_ID }}</string>
              <key>uploadBitcode</key>
              <false/>
              <key>uploadSymbols</key>
              <true/>
              <key>compileBitcode</key>
              <false/>
              <key>signingStyle</key>
              <string>automatic</string>
              <key>signingCertificate</key>
              <string>Apple Distribution</string>
              <key>provisioningProfiles</key>
              <dict>
                  <key>com.applotictech.flexaura</key>
                  <string></string>
              </dict>
          </dict>
          </plist>
          EOF
          echo "Export options created"

      - name: ðŸ“¦ Install CocoaPods dependencies
        working-directory: ./ios
        run: |
          echo "Installing CocoaPods dependencies..."
          sudo gem install cocoapods
          pod install --repo-update

      - name: ðŸ” Find Xcode Scheme
        working-directory: ./ios
        run: |
          echo "Finding Xcode scheme..."
          WORKSPACE=$(find . -name "*.xcworkspace" | head -1)
          if [ -z "$WORKSPACE" ]; then
            echo "Error: No .xcworkspace found"
            exit 1
          fi
          
          # Try to get scheme from xcodebuild
          SCHEME=$(xcodebuild -list -workspace "$WORKSPACE" 2>/dev/null | grep -A 10 "Schemes:" | grep -v "Schemes:" | head -1 | xargs || echo "")
          
          # Fallback: use app slug from app.json
          if [ -z "$SCHEME" ] || [ "$SCHEME" = "" ]; then
            SCHEME="flex-aura"
            echo "Using default scheme: $SCHEME"
          else
            echo "Found scheme: $SCHEME"
          fi
          
          echo "SCHEME_NAME=$SCHEME" >> $GITHUB_ENV
          echo "Using scheme: $SCHEME"

      - name: ðŸ—ï¸ Build Archive with Xcode
        working-directory: ./ios
        run: |
          echo "Building iOS archive..."
          
          # Find workspace
          WORKSPACE=$(find . -name "*.xcworkspace" | head -1)
          echo "Using workspace: $WORKSPACE"
          
          # Create build directory
          mkdir -p ./build
          
          # Build archive with absolute path
          ARCHIVE_PATH="$(pwd)/build/flex-aura.xcarchive"
          echo "Archive will be created at: $ARCHIVE_PATH"
          
          xcodebuild clean archive \
            -workspace "$WORKSPACE" \
            -scheme "${{ env.SCHEME_NAME }}" \
            -configuration Release \
            -archivePath "$ARCHIVE_PATH" \
            -allowProvisioningUpdates \
            DEVELOPMENT_TEAM="${{ secrets.APPLE_TEAM_ID }}" \
            CODE_SIGN_IDENTITY="Apple Distribution" \
            CODE_SIGN_STYLE="Automatic" \
            | xcpretty || true
          
          # Verify archive exists
          if [ -d "$ARCHIVE_PATH" ]; then
            echo "âœ… Archive created successfully at: $ARCHIVE_PATH"
            echo "ARCHIVE_PATH=$ARCHIVE_PATH" >> $GITHUB_ENV
          else
            echo "âŒ Archive not found at: $ARCHIVE_PATH"
            echo "Listing build directory:"
            ls -la ./build/ || echo "Build directory doesn't exist"
            exit 1
          fi

      - name: ðŸ“¦ Export IPA
        working-directory: ./ios
        run: |
          echo "Exporting IPA from archive..."
          
          # Use the archive path from previous step
          ARCHIVE_PATH="${{ env.ARCHIVE_PATH }}"
          if [ -z "$ARCHIVE_PATH" ]; then
            ARCHIVE_PATH="$(pwd)/build/flex-aura.xcarchive"
          fi
          
          echo "Looking for archive at: $ARCHIVE_PATH"
          
          # Verify archive exists
          if [ ! -d "$ARCHIVE_PATH" ]; then
            echo "âŒ Archive not found at: $ARCHIVE_PATH"
            echo "Current directory: $(pwd)"
            echo "Listing ios directory:"
            ls -la
            echo "Listing build directory (if exists):"
            ls -la ./build/ 2>/dev/null || echo "Build directory doesn't exist"
            exit 1
          fi
          
          echo "âœ… Archive found, proceeding with export..."
          
          EXPORT_PATH="$(pwd)/build"
          xcodebuild -exportArchive \
            -archivePath "$ARCHIVE_PATH" \
            -exportPath "$EXPORT_PATH" \
            -exportOptionsPlist ./exportOptions.plist \
            -allowProvisioningUpdates
          
          echo "IPA exported successfully"
          
          # Find the IPA file
          IPA_FILE=$(find "$EXPORT_PATH" -name "*.ipa" | head -1)
          if [ -z "$IPA_FILE" ]; then
            echo "âŒ IPA file not found in $EXPORT_PATH"
            echo "Listing export directory:"
            ls -la "$EXPORT_PATH"
            exit 1
          fi
          
          echo "âœ… IPA file found: $IPA_FILE"
          echo "IPA_PATH=$IPA_FILE" >> $GITHUB_ENV

      - name: ðŸ“¤ Upload IPA artifact
        uses: actions/upload-artifact@v4
        with:
          name: ios-production-ipa
          path: ios/build/*.ipa
          retention-days: 30
          if-no-files-found: error

      - name: ðŸ“‹ Build Summary
        run: |
          echo "## âœ… iOS Build Complete (Local Build)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Your IPA has been built locally on GitHub Actions Mac runner." >> $GITHUB_STEP_SUMMARY
          echo "**âœ… No EAS Build credits were used!**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Next Steps:**" >> $GITHUB_STEP_SUMMARY
          echo "1. Download the IPA from workflow artifacts (above)" >> $GITHUB_STEP_SUMMARY
          echo "2. Submit to App Store Connect:" >> $GITHUB_STEP_SUMMARY
          echo "   - Go to [App Store Connect](https://appstoreconnect.apple.com)" >> $GITHUB_STEP_SUMMARY
          echo "   - Upload the IPA manually, or" >> $GITHUB_STEP_SUMMARY
          echo "   - Use: \`eas submit --platform ios --path <ipa-file>\`" >> $GITHUB_STEP_SUMMARY
